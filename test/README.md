## Regression Testing Using a GitHub Action
### Files
.github/workflows/check_output.yml     the action which checks the output from run_pypsa.py

### test directory files
test_compare_output.py    the output compare program run by the action (after run_pypsa.py runs)

test_prefix.xlsx  the expected output from run_pypsa (note that this is in the test directory)

test_case.xlsx, solar.csv, wind.csv, demand.csv  used by run_pypsa during the action

### output_data/test_case directory files
test_prefix.xlsx generated by run_pypsa  (copy this to the test directory if the expected output changes)

## What triggers the action
In the 'on:' block of the action
- if 'push' appears then the action runs when any file is pushed to the table_pypsa repo
- if 'workflow_dispatch appears then the action can be manually triggered in the GitHub actions page

## What happens when the action runs
All actions spin up a new vm and checkout (copy) all files from the repo. Note that, unless specifically saved, all files generated during the action will disappear when the action completes. 

The check_output.yml runs run_pypsa. When it tries to read from DGE data directories an exception is thrown and the input path is set to the 'test' directory. A Gurobi license stored in the GUROBI_LIC GitHub secret is checked before running the optimization. The output of the run is put in the newly created output_data/test_case/test_prefix.xlsx located inside the vm (not in the repo's directory).

Next, test_compare_output.py runs which compares output_data/test_case/test_prefix.xlsx (just created) to test/test_prefix.xlsx (stored in the repo) by loading them into Pandas dataframes and using the .compare() method. If the files are identical the action completes successfully (displaying a green checkmark on the GitHub page). If the files are not identical the diff of the two dataframes is printed out to the action result window; this shows just where the two differ. An excpetion is raised so that the action fails and generates a red X in the action output window.

Normally the action will be run in a development branch and a Pull Request generated there only if the action runs successfully. 

## How to Update Files if the Expected Output Changes
This may occur if different input files are used or the network model changes.

In this case do:
- Run run_pypsa in your local repo
- Copy output_data/test_case/test_prefix.xlsx to the test directory.  Commit and push the test directory file. Note: files in output_data/test_case are NOT pushed to the GitHub repo (that directory is listed in the .gitignore file).

## Gurobi license
A WLS license is required to run on GitHub servers. The license expires every 90 days.

When you acquire a new one store it in the GitHub secret by going to the repo page, click Settings, then 'Secrets and Variables' in the left hand menu, then Actions in the sub-menu. In the Repository Secrets block to the right of the 'GUROBI_LIC' title click the pencil icon and update it (log in with your GitHub password).
